# Daily Task Assistant - Project Rules

## Project Overview

This is the **Daily Task Assistant (DATA)** project - a FastAPI backend + React frontend application that helps David manage tasks from Smartsheet with AI assistance.

## Architecture

```
projects/
‚îú‚îÄ‚îÄ daily-task-assistant/     # FastAPI backend
‚îÇ   ‚îú‚îÄ‚îÄ api/main.py           # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ daily_task_assistant/ # Core Python modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm/              # Anthropic integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conversations/    # Chat history persistence
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actions/          # Task planning logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sheets/           # Google Sheets integration (email rules)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email/            # Email analysis and suggestions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/         # Assist workflow orchestration
‚îÇ   ‚îú‚îÄ‚îÄ config/smartsheet.yml # Smartsheet schema
‚îÇ   ‚îú‚îÄ‚îÄ DATA_PREFERENCES.md   # DATA's behavioral guidelines
‚îÇ   ‚îî‚îÄ‚îÄ tests/                # pytest unit tests
‚îÇ
‚îú‚îÄ‚îÄ web-dashboard/            # React + Vite frontend
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ App.tsx           # Main application
‚îÇ       ‚îú‚îÄ‚îÄ api.ts            # Backend API client
‚îÇ       ‚îú‚îÄ‚îÄ components/       # React components
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ EmailDashboard.tsx  # Email management UI
‚îÇ       ‚îî‚îÄ‚îÄ auth/             # Google OAuth integration
‚îÇ
‚îî‚îÄ‚îÄ e2e-tests/                # Playwright regression tests
    ‚îú‚îÄ‚îÄ playwright.config.ts  # Multi-browser test config
    ‚îî‚îÄ‚îÄ tests/
        ‚îú‚îÄ‚îÄ api-health.spec.ts    # Backend API health checks
        ‚îú‚îÄ‚îÄ tasks/                # Task list & portfolio tests
        ‚îî‚îÄ‚îÄ email/                # Email management tests
```

## Code Style

### Python (Backend)
- **Python 3.11+** with type hints everywhere
- **Dataclasses with `slots=True`** for models
- **Snake_case** for variables and functions
- **Docstrings** on all public functions
- **Pydantic v2** for API request/response models
- Use `from __future__ import annotations` at top of files

```python
# ‚úÖ Good
@dataclass(slots=True)
class TaskDetail:
    """Represents a task from Smartsheet."""
    row_id: str
    title: str
    status: str

def fetch_tasks(limit: Optional[int] = None) -> List[TaskDetail]:
    """Fetch tasks from Smartsheet."""
    ...

# ‚ùå Bad
class TaskDetail:
    def __init__(self, row_id, title, status):
        self.row_id = row_id
```

### TypeScript (Frontend)
- **Functional components with hooks**
- **CamelCase** for variables, **PascalCase** for components
- **Async/await** for API calls
- **Types in `types.ts`**, API functions in `api.ts`

```typescript
// ‚úÖ Good
export async function fetchTasks(auth: AuthConfig): Promise<TaskResponse> {
  const resp = await fetch(url, { headers: buildHeaders(auth) })
  return resp.json()
}

// ‚ùå Bad
export function fetchTasks(auth) {
  return fetch(url).then(r => r.json())
}
```

## Key Files to Know

| File | Purpose |
|------|---------|
| `api/main.py` | All FastAPI endpoints |
| `llm/anthropic_client.py` | Anthropic API integration, system prompts |
| `smartsheet_client.py` | Smartsheet API wrapper |
| `DATA_PREFERENCES.md` | DATA's behavioral guidelines - READ THIS |
| `config/smartsheet.yml` | Column IDs and validation rules |
| `App.tsx` | Main React component, state management |
| `AssistPanel.tsx` | Assistant UI, chat interface |
| `EmailDashboard.tsx` | Email management UI |
| `sheets/filter_rules.py` | Google Sheets email rules integration |
| `email/analyzer.py` | Email pattern detection and suggestions |
| `e2e-tests/playwright.config.ts` | Playwright test configuration |

## Development Workflow

### Starting Dev Servers
```powershell
cd projects/daily-task-assistant
powershell -ExecutionPolicy Bypass -File .\scripts\start-dev.ps1
```
- Backend: http://localhost:8000
- Frontend: http://localhost:5173

### Running Unit Tests
```powershell
cd projects/daily-task-assistant
python -m pytest tests/ -v
```

### Running E2E Regression Tests
```powershell
cd projects/e2e-tests
npm test              # Run all tests headless
npm run test:ui       # Interactive UI mode (recommended for debugging)
npm run test:headed   # Watch browser as tests run
npm run test:chrome   # Chrome only (faster)
```

### Environment Variables
The `.env` file in `projects/daily-task-assistant/` contains:
- `SMARTSHEET_API_TOKEN` - Smartsheet access
- `ANTHROPIC_API_KEY` - Claude API
- `GOOGLE_APPLICATION_CREDENTIALS` - Firestore access
- Gmail OAuth credentials for church/personal accounts

## Important Conventions

### API Endpoints
- `POST /assist/{task_id}` - Engage with a task (load context)
- `POST /assist/{task_id}/plan` - Generate a plan
- `POST /assist/{task_id}/chat` - Send chat message
- `POST /assist/{task_id}/research` - Web research
- `POST /assist/{task_id}/update` - Update Smartsheet
- `POST /assist/{task_id}/feedback` - Submit feedback on DATA response
- `GET /feedback/summary` - Get aggregated feedback statistics

### Conversation History
- Stored in Firestore (production) or local JSON files (dev)
- Set `DTA_CONVERSATION_FORCE_FILE=1` for local file storage
- History is per-task, cleared when task is marked complete

### Feedback System
- Stored in Firestore (production) or `feedback_log/feedback.jsonl` (dev)
- Set `DTA_FEEDBACK_FORCE_FILE=1` for local file storage
- Feedback is collected on research, plans, chat responses, and task updates
- Used to improve DATA's responses over time through tuning sessions

### Authentication
- Production: Google OAuth with ID token verification
- Development: Set `DTA_DEV_AUTH_BYPASS=1` and use `X-User-Email` header

## Boundaries

### ‚úÖ Do
- Write tests for new backend functionality
- Run `npx tsc --noEmit` before committing frontend changes
- Update `DATA_PREFERENCES.md` when changing DATA's behavior
- Commit at logical checkpoints with descriptive messages
- **Run E2E tests after significant UI or API changes** (see Testing Workflow below)
- Add E2E tests when building new user-facing features

### ‚ö†Ô∏è Ask First
- Changes to Smartsheet schema (`config/smartsheet.yml`)
- New API endpoints that modify external data
- Changes to authentication flow

### üö´ Don't
- Hardcode API keys or secrets
- Skip tests for Smartsheet write operations
- Change DATA's personality without updating preferences file
- Deploy to production without user approval
- **Make assumptions about UI/UX changes** - Always present plans for approval before implementing
- Skip regression tests before merging to staging/main

## Common Tasks

### Adding a New DATA Capability
1. Define the tool in `llm/anthropic_client.py`
2. Add endpoint in `api/main.py`
3. Add frontend API function in `api.ts`
4. Update UI in `AssistPanel.tsx`
5. Document in `DATA_PREFERENCES.md`
6. Write tests

### Fixing DATA's Response Behavior
1. Check `DATA_PREFERENCES.md` for expected behavior
2. Update system prompt in `anthropic_client.py`
3. Add example to preferences file
4. Test with real conversation

### Conducting a Tuning Session (Scheduled Maintenance)
1. Pull feedback summary: `GET /feedback/summary?days=30`
2. Review `needs_work` patterns - what's consistently flagged?
3. Update `DATA_PREFERENCES.md` with new examples or anti-patterns
4. Adjust system prompts in `anthropic_client.py` if needed
5. Track `helpfulRate` over time to measure improvement
6. Document changes in version history

### Adding Smartsheet Field Support
1. Get column ID from Smartsheet API
2. Add to `config/smartsheet.yml`
3. Update `SmartsheetClient` if needed
4. Add validation in API endpoint

## E2E Testing Workflow

### When to Run E2E Tests

| Situation | Action |
|-----------|--------|
| **Before merging to staging/main** | Run full suite: `npm test` |
| **After UI component changes** | Run relevant tests: `npm run test:tasks` or `npm run test:email` |
| **After API endpoint changes** | Run API health: `npm run test:api` |
| **Debugging a test failure** | Use interactive UI: `npm run test:ui` |
| **Building a new feature** | Use codegen to record: `npm run codegen` |

### Test Categories

```powershell
cd projects/e2e-tests

# API Health (4 tests) - Backend connectivity
npm run test:api

# Task Management (14 tests) - Task list, filters, portfolio
npm run test:tasks

# Email Management (14 tests) - Dashboard, rules, account switching
npm run test:email

# All tests across browsers
npm test
```

### Writing New E2E Tests

1. Create a `.spec.ts` file in the appropriate `tests/` subdirectory
2. Use `test.beforeEach` to set up auth headers:
   ```typescript
   test.beforeEach(async ({ page }) => {
     await page.goto('/');
     await page.setExtraHTTPHeaders({
       'X-User-Email': 'david.a.royes@gmail.com'
     });
   });
   ```
3. Use Playwright's locators: `page.getByRole()`, `page.getByText()`, `page.getByPlaceholder()`
4. Use `expect()` assertions with appropriate timeouts for async operations

### Recording Tests with Codegen

Playwright can record your browser interactions and generate test code:

```powershell
cd projects/e2e-tests
npm run codegen   # Opens browser - click around, code appears
```

### Debugging Failed Tests

1. **View HTML report**: `npm run report`
2. **Interactive mode**: `npm run test:ui` (lets you step through)
3. **Debug mode**: `npm run test:debug` (pauses at breakpoints)
4. **Screenshots**: Auto-captured in `test-results/` on failure

## Git Workflow

- Branch: `Daily-Task-Assistant`
- Commit messages: `type: description` (feat, fix, docs, test)
- Push after each logical milestone
- Create restore points before major changes

## Resources

- [Smartsheet API Docs](https://smartsheet.redoc.ly/)
- [Anthropic API Docs](https://docs.anthropic.com/)
- [FastAPI Docs](https://fastapi.tiangolo.com/)
- GitHub: `d-royes/personal-solutions-projects`

